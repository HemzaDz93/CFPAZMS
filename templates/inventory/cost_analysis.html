{% extends "base.html" %}

{% block title %}تحليل التكاليف{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3">
                    <i class="fas fa-dollar-sign me-2"></i>تحليل التكاليف والقيم
                </h1>
                <a href="{{ url_for('inventory.items') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>العودة
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">إجمالي قيمة المخزون</h6>
                    <h3 class="text-primary">{{ "%.2f"|format(total_inventory_value) }} دج</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">متوسط سعر الوحدة</h6>
                    <h3 class="text-success">{{ "%.2f"|format(average_unit_price) }} دج</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">أعلى قيمة صنف</h6>
                    <h3 class="text-warning">{{ "%.2f"|format(max_item_value) }} دج</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-danger">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">إجمالي الأصناف</h6>
                    <h3 class="text-danger">{{ items|length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Distribution Chart -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">توزيع القيم حسب الفئة</h5>
                </div>
                <div class="card-body">
                    <canvas id="costByCategory" height="60"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">أعلى 10 أصناف قيمة</h5>
                </div>
                <div class="card-body">
                    <canvas id="topItemsChart" height="60"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>تفاصيل التكاليف
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>الكود</th>
                                    <th>الصنف</th>
                                    <th>الفئة</th>
                                    <th>الكمية</th>
                                    <th>سعر الوحدة</th>
                                    <th>القيمة الإجمالية</th>
                                    <th>النسبة %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ item.code }}</span>
                                    </td>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.category.name if item.category else '-' }}</td>
                                    <td class="text-center">{{ item.quantity_in_stock }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.unit_price or 0) }} دج</td>
                                    <td class="text-end font-weight-bold">{{ "%.2f"|format((item.quantity_in_stock or 0) * (item.unit_price or 0)) }} دج</td>
                                    <td class="text-center">{{ "%.2f"|format((((item.quantity_in_stock or 0) * (item.unit_price or 0)) / total_inventory_value * 100) if total_inventory_value > 0 else 0) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Build category map and top items from table data
    const categoryMap = {};
    const topItemsData = [];
    
    // Get all table rows and extract data
    const rows = document.querySelectorAll('table tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
            const categoryName = cells[2].textContent.trim();
            const valueText = cells[5].textContent.trim().replace(' دج', '');
            const value = parseFloat(valueText) || 0;
            const itemName = cells[1].textContent.trim();
            
            // Build category map
            categoryMap[categoryName] = (categoryMap[categoryName] || 0) + value;
            
            // Track for top items
            topItemsData.push({name: itemName, value: value});
        }
    });
    
    // Cost by Category Chart
    const categoryCtx = document.getElementById('costByCategory').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryMap),
            datasets: [{
                data: Object.values(categoryMap),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Top Items Chart
    const topItemsCtx = document.getElementById('topItemsChart').getContext('2d');
    const topItems = topItemsData.sort((a, b) => b.value - a.value).slice(0, 10);
    
    new Chart(topItemsCtx, {
        type: 'bar',
        data: {
            labels: topItems.map(i => i.name),
            datasets: [{
                label: 'القيمة',
                data: topItems.map(i => i.value),
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}