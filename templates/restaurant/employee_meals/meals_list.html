{% extends 'base.html' %}

{% block title %}Ø³Ø¬Ù„ ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="page-title">ğŸ“‹ Ø³Ø¬Ù„ ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            <p class="text-muted">Ø¹Ø±Ø¶ ÙˆØªØªØ¨Ø¹ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„ÙˆØ¬Ø¨Ø§Øª</p>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„Ø¨Ø­Ø« -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <select class="form-select" name="employee_id">
                        <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† --</option>
                        {% for emp in employees %}
                            <option value="{{ emp.id }}" {% if emp.id == employee_id %}selected{% endif %}>
                                {{ emp.full_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
                    <input type="month" class="form-control" name="month" value="{{ month }}">
                </div>

                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-funnel"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©
                    </button>
                    <a href="{{ url_for('employee_meals.meals_list') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-clockwise"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„Ù…Ù†ØµØ¨</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</th>
                        <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% if transactions %}
                        {% for trans in transactions %}
                            <tr>
                                <td>
                                    <small>{{ trans.transaction_date.strftime('%d/%m/%Y') }}</small>
                                </td>
                                <td>
                                    <strong>{{ trans.user.full_name }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">{{ trans.user.position or trans.user.role }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ (trans.meal_cost / 2.5) | int }}</span>
                                </td>
                                <td>
                                    <strong class="text-success">{{ "%.2f"|format(trans.final_cost) }} Ø¯Ø¬</strong>
                                </td>
                                <td>
                                    {% if trans.is_settled %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Ù…Ø¯ÙÙˆØ¹Ø©
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-hourglass-split"></i> Ù…Ø¹Ù„Ù‚Ø©
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ trans.notes[:30] if trans.notes else '-' }}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="bi bi-inbox"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ±Ù‚ÙŠÙ… -->
    {% if pages > 1 %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% if current_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if month %}&month={{ month }}{% endif %}">Ø§Ù„Ø£ÙˆÙ„Ù‰</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ current_page - 1 }}{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if month %}&month={{ month }}{% endif %}">Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a>
                    </li>
                {% endif %}

                {% for page_num in range(max(1, current_page - 2), min(pages + 1, current_page + 3)) %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="?page={{ page_num }}{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if month %}&month={{ month }}{% endif %}">{{ page_num }}</a>
                    </li>
                {% endfor %}

                {% if current_page < pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ current_page + 1 }}{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if month %}&month={{ month }}{% endif %}">Ø§Ù„ØªØ§Ù„ÙŠØ©</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ pages }}{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if month %}&month={{ month }}{% endif %}">Ø§Ù„Ø£Ø®ÙŠØ±Ø©</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© -->
    <div class="row mt-4">
        <div class="col-md-8 mx-auto">
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <a href="{{ url_for('employee_meals.daily_registration') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> ØªØ³Ø¬ÙŠÙ„ ÙˆØ¬Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                </a>
                <a href="{{ url_for('employee_meals.monthly_report') }}" class="btn btn-info">
                    <i class="bi bi-file-earmark-pdf"></i> Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ
                </a>
                <a href="{{ url_for('employee_meals.alerts_list') }}" class="btn btn-warning">
                    <i class="bi bi-bell"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
                </a>
                <a href="{{ url_for('restaurant.meals') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Ø±Ø¬ÙˆØ¹
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}