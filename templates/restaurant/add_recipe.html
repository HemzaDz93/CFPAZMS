{% extends "base.html" %}

{% block title %}إضافة وصفة جديدة - نظام الإدارة{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="page-title">
                <i class="fas fa-plus-circle"></i> إضافة وصفة جديدة
            </h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-book"></i> بيانات الوصفة
                </div>
                <div class="card-body">
                    <form method="POST" id="recipeForm" class="needs-validation">
                        <!-- Basic Info -->
                        <div class="mb-3">
                            <h5 class="card-title">المعلومات الأساسية</h5>
                            <hr>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="code" class="form-label">كود الوصفة <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="code" name="code" required 
                                       placeholder="مثال: RCP001">
                            </div>
                            <div class="col-md-6">
                                <label for="name" class="form-label">اسم الوصفة <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="مثال: طبق العدس">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="servings" class="form-label">عدد الحصص <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="servings" name="servings" required 
                                       min="1" placeholder="مثال: 10">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">الوصف/الملاحظات</label>
                            <textarea class="form-control" id="description" name="description" rows="2" 
                                      placeholder="وصف الوصفة وأي ملاحظات مهمة..."></textarea>
                        </div>

                        <!-- Ingredients -->
                        <div class="mb-3">
                            <h5 class="card-title">المكونات</h5>
                            <hr>
                        </div>

                        <div id="ingredientsList">
                            <div class="ingredient-row mb-3 p-3 border rounded">
                                <div class="row">
                                    <div class="col-md-5">
                                        <label class="form-label">الصنف <span class="text-danger">*</span></label>
                                        <select class="form-select ingredient-item" name="item_id[]" required>
                                            <option value="">-- اختر الصنف --</option>
                                            {% for item in items %}
                                            <option value="{{ item.id }}" data-unit="{{ item.unit }}">
                                                {{ item.code }} - {{ item.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الكمية <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control ingredient-qty" name="quantity[]" required 
                                               min="0.01" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الوحدة</label>
                                        <input type="text" class="form-control ingredient-unit" name="unit[]" disabled>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-danger btn-remove-ingredient w-100">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" id="addIngredientBtn" class="btn btn-outline-success">
                                <i class="fas fa-plus"></i> إضافة مكون آخر
                            </button>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> إضافة الوصفة
                            </button>
                            <a href="{{ url_for('restaurant.recipes') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> إلغاء
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsList = document.getElementById('ingredientsList');
    const addBtn = document.getElementById('addIngredientBtn');

    // Handle adding new ingredient row
    addBtn.addEventListener('click', function() {
        const newRow = document.querySelector('.ingredient-row').cloneNode(true);
        // Clear the inputs
        newRow.querySelectorAll('input, select').forEach(el => {
            if (el.classList.contains('ingredient-item') || el.classList.contains('ingredient-qty')) {
                el.value = '';
            }
        });
        ingredientsList.appendChild(newRow);
        attachEventListeners();
    });

    // Handle removing ingredient rows
    function attachEventListeners() {
        document.querySelectorAll('.btn-remove-ingredient').forEach(btn => {
            btn.addEventListener('click', function() {
                const rows = document.querySelectorAll('.ingredient-row');
                if (rows.length > 1) {
                    this.closest('.ingredient-row').remove();
                } else {
                    alert('يجب أن تحتوي الوصفة على مكون واحد على الأقل');
                }
            });
        });

        // Handle unit auto-fill
        document.querySelectorAll('.ingredient-item').forEach(select => {
            select.addEventListener('change', function() {
                const row = this.closest('.ingredient-row');
                const unitInput = row.querySelector('.ingredient-unit');
                const unit = this.options[this.selectedIndex].dataset.unit;
                unitInput.value = unit;
            });
        });
    }

    attachEventListeners();
});
</script>
{% endblock %}